<!DOCTYPE html>
<html>
<head lang='en'>
    <meta charset='UTF-8'>
    <title></title>
    <script src='../js/d3/d3.js'></script>
    <script src='../js/jquery/dist/jquery.js'></script>
    <style>
        .male {
            fill: #00b3ee;
        }

        .female {
            fill: #008bbd;
        }

        .cap {
            fill: #36d46d;
        }

        .unreached {
            fill: #e2e2e2;
        }

        .axis path {
            fill: none;
            stroke: #000;
        }

        .axis .tick {
            font-family: sans-serif;
        }

        svg * {
            shape-rendering: crispEdges;
        }
    </style>
</head>
<body>
<div id='recruitment'></div>
<script>
    var svgWidth = 1000, svgHeight = 500;
    var margin = {top: 30, bottom: 50, right: 20, left: 100};
    var chartWidth = svgWidth - margin.right - margin.left, chartHeight = svgHeight - margin.top - margin.bottom;
    var capThickness = 10;
    var padding = 5;
    var cohortArray, targetArray, layers;
    var stack, stackMax, barTypes, caps;

    function getData(allData){
        var dataset = [[], [], []];
        allData.forEach(function (group, index) {

            var unreached;
            group.total = group.male + group.female;
            if (!group.target) {
                unreached = 0;
            } else {
                unreached = group.target - group.total;
            }
            if (unreached < 0)  unreached = 0;
            dataset[0].push({x: group.cohort, y: group.male});
            dataset[1].push({x: group.cohort, y: group.female});
            dataset[2].push({x: group.cohort, y: unreached});

        });
        return d3.layout.stack()(dataset);
    }

    function drawChart(chart,numberScale,cohortScale,classScale){
        barTypes = chart.selectAll('.types').data(stack).enter()
                .append('g').attr('class', function (d, i) {
                    console.log(d, i, classScale(i));
                    return classScale(i);
                });
        barTypes.selectAll('rect').data(function (d) {
            return d;
        }).enter().append('rect').attr({
            y: function (d) {
                return cohortScale(d.x);
            },
            x: function (d, i) {
                console.log(i, d.x, cohortArray[d.x], d.y0, d.y);
                return numberScale(d.y0);
            },
            height: cohortScale.rangeBand(),
            width: function (d) {
                return numberScale(d.y)
            }
        });

        caps = chart.selectAll('.cap').data(targetArray).enter()
                .append('rect').attr({
                    height: cohortScale.rangeBand(),
                    width: function (d) {
                        return d3.min([numberScale(d), capThickness]);
                    },
                    y: function (d, i) {
                        return cohortScale(cohortArray[i]);
                    },
                    x: function (d) {
                        return d3.max([numberScale(d) - capThickness, 0]);
                    },
                    class: 'cap'
                });

    }
    function newChart (error, data) {

        cohortArray = data.stats.map(function (g) {
            return g.cohort
        });
        targetArray = data.stats.map(function (g) {
            return g.target
        });
        stack = getData(data.stats);
        var svg = d3.select('#recruitment').append('svg').attr({
            'width': svgWidth,
            'height': svgHeight
        });

        stackMax = d3.max(stack, function (layer) {
            return d3.max(layer, function (d) {
                return d.y0 + d.y;
            });
        });

        var numberScale = d3.scale.linear().domain([0, stackMax]).range([0, chartWidth]);
        var cohortScale = d3.scale.ordinal().domain(cohortArray).rangeRoundBands([0, chartHeight], .3);
        var classScale = d3.scale.ordinal().domain(d3.range(3)).range(['male bar', 'female bar', 'unreached bar']);
        var translateToChart = 'translate(' + margin.left + ',' + margin.top + ')';

        var chart = svg.append('g').attr({
            width: chartWidth,
            height: chartHeight,
            id: 'chart',
            transform: translateToChart

        });
        drawChart(chart,numberScale,cohortScale,classScale);
        var numberAxis = d3.svg.axis().scale(numberScale).orient('bottom').ticks(20);
        var cohortAxis = d3.svg.axis().scale(cohortScale).orient('left');//.tickValues(cohortArray);
        var numberGuide = svg.append('g').attr({
            'id': 'numberAxis',
            'class': 'axis',
            'transform': 'translate(' + margin.left + ',' + (svgHeight - margin.bottom) + ')'
        });
        var cohortGuide = svg.append('g').attr({
            'id': 'cohortAxis',
            'class': 'axis',
            'transform': translateToChart
        });
        numberAxis(numberGuide);
        cohortAxis(cohortGuide);
        /*
         * TODO: displaying stats on mouseover
         * */
    }

    var json = d3.json('default_all.json', newChart);
</script>

</body>
</html>